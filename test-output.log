/Users/alexander.marston/code/tofu-controller-new/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config="config/crd/bases"
cp config/crd/bases/infra.contrib.fluxcd.io_terraforms.yaml charts/tofu-controller/crds/crds.yaml
cd api; /Users/alexander.marston/code/tofu-controller-new/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config="../config/crd/bases"
go generate ./...

WARNING: Invoking counterfeiter multiple times from "go generate" is slow.
Consider using counterfeiter:generate directives to speed things up.
See https://github.com/maxbrunsfeld/counterfeiter#step-2b---add-counterfeitergenerate-directives for more information.
Set the "COUNTERFEITER_NO_GENERATE_WARNING" environment variable to suppress this message.

/Users/alexander.marston/code/tofu-controller-new/bin/controller-gen object:headerFile="hack/boilerplate.go.txt" paths="./..."
cd api; /Users/alexander.marston/code/tofu-controller-new/bin/controller-gen object:headerFile="../hack/boilerplate.go.txt" paths="./..."
curl -s https://raw.githubusercontent.com/fluxcd/source-controller/v1.0.0-rc.1/config/crd/bases/source.toolkit.fluxcd.io_gitrepositories.yaml > config/crd/bases/gitrepositories.yaml
curl -s https://raw.githubusercontent.com/fluxcd/source-controller/v1.0.0-rc.1/config/crd/bases/source.toolkit.fluxcd.io_buckets.yaml > config/crd/bases/buckets.yaml
curl -s https://raw.githubusercontent.com/fluxcd/source-controller/v1.0.0-rc.1/config/crd/bases/source.toolkit.fluxcd.io_ocirepositories.yaml > config/crd/bases/ocirepositories.yaml
go fmt ./...
go vet ./...
/Users/alexander.marston/code/tofu-controller-new/bin/gen-crd-api-reference-docs -api-dir=./api/v1alpha2 -config=./hack/api-docs/config.json -template-dir=./hack/api-docs/template -out-file=./docs/References/terraform.md
INSECURE_LOCAL_RUNNER=1 DISABLE_K8S_LOGS=1 DISABLE_TF_LOGS=1 DISABLE_TF_K8S_BACKEND=1 DISABLE_WEBHOOK_TLS_VERIFY=1 KUBEBUILDER_ASSETS="/Users/alexander.marston/code/tofu-controller-new/testbin/k8s/1.34.1-darwin-amd64" go test ./controllers -coverprofile cover.out -v
=== RUN   TestGetRunnerPodObjectKey
--- PASS: TestGetRunnerPodObjectKey (0.00s)
=== RUN   TestObjectEncode
--- PASS: TestObjectEncode (0.00s)
=== RUN   TestSourceRevisionChangePredicate_Update
--- PASS: TestSourceRevisionChangePredicate_Update (0.00s)
=== RUN   Test_000010_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with no backend, and `auto` approve.
[1mIT[0m should be reconciled to have available outputs.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id.
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206e3d0cbb7ed22ced771a0056455a2fb in its labels.
[1mIT[0m should contain an Apply condition saying that the plan were apply successfully.
[1mBY[0m: checking that the reason of the Apply condition is TerraformAppliedSucceed, and the LastAppliedPlan is the plan.
[1mIT[0m should have an available output.
[1mBY[0m: checking that the Terraform resource's .status.availableOutputs contains hello_world as an output name.
[1mIT[0m should not produce a Secret because the controller runs locally, outside Kubernetes.
[1mBY[0m: checking there are no secret generated by default.
--- PASS: Test_000010_no_outputs_test (3.75s)
=== RUN   Test_000011_bad_tar_gz_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource that obtains a bad tar.gz file blob from its Source reference.
[1mIT[0m should report the error and stop reconcile.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable *bad* BLOB's URL, with the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the bad GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the bad repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has 1 element.
[1mIT[0m should be an error
[1mBY[0m: checking that the Ready's reason of the TF resource become `ArtifactFailed`.
--- PASS: Test_000011_bad_tar_gz_no_outputs_test (1.04s)
=== RUN   Test_000011_workspace_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with no backend, and `auto` approve.
[1mIT[0m should be reconciled to have available outputs.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id.
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206e3d0cbb7ed22ced771a0056455a2fb in its labels.
[1mIT[0m should contain an Apply condition saying that the plan were apply successfully.
[1mBY[0m: checking that the reason of the Apply condition is TerraformAppliedSucceed, and the LastAppliedPlan is the plan.
[1mIT[0m should have an available output.
[1mBY[0m: checking that the Terraform resource's .status.availableOutputs contains hello_world as an output name.
[1mIT[0m should not produce a Secret because the controller runs locally, outside Kubernetes.
[1mBY[0m: checking there are no secret generated by default.
--- PASS: Test_000011_workspace_no_outputs_test (1.05s)
=== RUN   Test_000012_src_bucket_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource which is stored in an S3-compatible bucket. There is no backend and auto-approve is enabled.
[1mIT[0m should be reconciled to have available outputs.
[1mGIVEN[0m: a Bucket
[1mBY[0m: defining a new Bucket resource.
[1mBY[0m: creating the Bucket resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the Bucket's reconciled status.
[1mBY[0m: setting the Bucket's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given Bucket resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mIT[0m should generate the Secret containing the plan named with the artifact revision
[1mBY[0m: checking that the Secret contains plan-822c3dd335 in its labels.
[1mIT[0m should contain an Apply condition saying that the plan were apply successfully.
[1mBY[0m: checking that the reason of the Apply condition is TerraformAppliedSucceed, and the LastAppliedPlan is the plan.
[1mIT[0m should have an available output.
[1mBY[0m: checking that the Terraform resource's .status.availableOutputs contains hello_world as an output name.
[1mIT[0m should not produce a Secret because the controller runs locally, outside Kubernetes.
[1mBY[0m: checking there are no secret generated by default.
--- PASS: Test_000012_src_bucket_no_outputs_test (1.06s)
=== RUN   Test_000012_src_ocirepository_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource which is stored in an OCIRepository. There is no backend and auto-approve is enabled.
[1mIT[0m should be reconciled to have available outputs.
[1mGIVEN[0m: an OCIRepository
[1mBY[0m: defining a new OCIRepository resource.
[1mBY[0m: creating the OCIRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the OCIRepository's reconciled status.
[1mBY[0m: setting the OCIRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given OCIRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mIT[0m should generate the Secret containing the plan named with the artifact revision
[1mBY[0m: checking that the Secret contains plan-v4.38.0-v1alpha11-6033f3b9fb in its labels.
[1mIT[0m should contain an Apply condition saying that the plan were apply successfully.
[1mBY[0m: checking that the reason of the Apply condition is TerraformAppliedSucceed, and the LastAppliedPlan is the plan.
[1mIT[0m should have an available output.
[1mBY[0m: checking that the Terraform resource's .status.availableOutputs contains hello_world as an output name.
[1mIT[0m should not produce a Secret because the controller runs locally, outside Kubernetes.
[1mBY[0m: checking there are no secret generated by default.
--- PASS: Test_000012_src_ocirepository_no_outputs_test (1.07s)
=== RUN   Test_000015_cross_namespace_cliconfigsecretref_denied_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when .spec.cliConfigSecretRef is in another namespace and cross-namespace refs are not allowed.
[1mIT[0m should be reconciled to have an access denied error.
[1mBY[0m: setting the reconciler to disallow cross-namespace refs
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mIT[0m should be access denied error.
[1mBY[0m: checking that the Ready's reason of the TF resource become `AccessDenied`.
--- PASS: Test_000015_cross_namespace_cliconfigsecretref_denied_test (0.53s)
=== RUN   Test_000015_cross_namespace_depends_on_denied_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when dependsOn is in another namespace and cross-namespace refs are not allowed.
[1mIT[0m should be reconciled to have a dependsOn error.
[1mBY[0m: setting the reconciler to disallow cross-namespace refs
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mIT[0m should be access denied error.
[1mBY[0m: checking that the Ready's reason of the TF resource become `AccessDenied`.
--- PASS: Test_000015_cross_namespace_depends_on_denied_test (0.52s)
=== RUN   Test_000015_cross_namespace_source_denied_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when source is in another namespace and cross-namespace refs are not allowed.
[1mIT[0m should be reconciled to have a Source error.
[1mBY[0m: setting the reconciler to disallow cross-namespace refs
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: a Terraform resource, attached to a GitRepository resource in another namespace.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mIT[0m should be access denied error.
[1mBY[0m: checking that the Ready's reason of the TF resource become `AccessDenied`.
--- PASS: Test_000015_cross_namespace_source_denied_test (0.53s)
=== RUN   Test_000016_default_observed_generation
[1mSPEC[0m: This spec describes default value of a Terraform resource
[1mIT[0m should set the observedGeneration to -1 when the resource is created
[1mGIVEN[0m: a Terraform resource
[1mBY[0m: creating a new TF resource.
[1mIT[0m should be created and attached successfully.
[1mIT[0m should have observedGeneration set to -1
--- PASS: Test_000016_default_observed_generation (0.01s)
=== RUN   Test_000016_finalize_status
[1mSPEC[0m: This spec describes the behaviour of the Terraform controller when finalizing the status of a Terraform resource
[1mIT[0m should set the observedGeneration and LastHandledReconcileAt after reconcile
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource
[1mBY[0m: creating a new TF resource.
[1mIT[0m should be created and attached successfully.
[1mIT[0m should have observedGeneration and LastHandledReconcileAt set
--- PASS: Test_000016_finalize_status (0.53s)
=== RUN   Test_000020_with_backend_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with backend configured, and `auto` approve.
[1mIT[0m should be reconciled from the plan state, to the apply state and have a correct TFSTATE stored inside the cluster as a Secret.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new Git repository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mIT[0m should be retrievable by the k8s client.
[1mBY[0m: getting it with the k0s client and succeed.
[1mGIVEN[0m: a Terraform resource with auto approve, backend configured, attached to the given GitRepository.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should apply successfully.
[1mBY[0m: checking that the status of the TF resource is `TerraformAppliedSucceed`.
[1mIT[0m should be reconciled successfully, and have some output available.
[1mBY[0m: checking the output reason of the TF resource being `TerraformOutputsAvailable`.
[1mBY[0m: checking that the .status.availableOutputs contains an output named `hello_world`.
[1mBY[0m: checking that the TFSTATE secret are created in the same TF resource's namespace.
--- PASS: Test_000020_with_backend_no_outputs_test (2.07s)
=== RUN   Test_000020_with_workspace_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with backend configured, workspace selected, and `auto` approve.
[1mIT[0m should be reconciled from the plan state, to the apply state and have a correct TFSTATE stored inside the cluster as a Secret.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new Git repository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mIT[0m should be retrievable by the k8s client.
[1mBY[0m: getting it with the k0s client and succeed.
[1mGIVEN[0m: a Terraform resource with auto approve, backend configured, attached to the given GitRepository.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should apply successfully.
[1mBY[0m: checking that the status of the TF resource is `TerraformAppliedSucceed`.
[1mIT[0m should be reconciled successfully, and have some output available.
[1mBY[0m: checking the output reason of the TF resource being `TerraformOutputsAvailable`.
[1mBY[0m: checking that the .status.availableOutputs contains an output named `hello_world`.
[1mBY[0m: checking that the TFSTATE secret are created in the same TF resource's namespace.
--- PASS: Test_000020_with_workspace_no_outputs_test (2.08s)
=== RUN   Test_000030_plan_only_no_outputs_test
[1mSPEC[0m: This spec describes the planning behaviour of a Terraform resource in the manual mode.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mIT[0m should be stopped.
[1mBY[0m: checking the ready condition is still Plan after 5 seconds.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id.
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206e3d0cbb7ed22ced771a0056455a2fb in its labels.
--- PASS: Test_000030_plan_only_no_outputs_test (6.08s)
=== RUN   Test_000031_plan_only_with_showplan_as_cm_no_outputs_test
[1mSPEC[0m: This spec describes the planning behaviour of a Terraform resource in the manual mode.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve with plan details in configmap.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id.
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206e3d0cbb7ed22ced771a0056455a2fb in its labels.
[1mIT[0m should generate the ConfigMap containing the plan details named with branch and commit id.
[1mBY[0m: checking that the ConfigMap contains plan-master-b8e362c206e3d0cbb7ed22ced771a0056455a2fb in its labels.
[1mBY[0m: checking that the ConfigMap contains the plan details.
--- PASS: Test_000031_plan_only_with_showplan_as_cm_no_outputs_test (1.06s)
=== RUN   Test_000040_controlled_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when it is controlled the set of outputs.
[1mIT[0m should be reconciled and have a specific set of outputs.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, with controlled output, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: specifying the .spec.writeOutputsToSecret to output only `hello_world` output.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains a binary data.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
--- PASS: Test_000040_controlled_outputs_test (1.06s)
=== RUN   Test_000041_all_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when not specified a list of output to .spec.writeOutputsToSecret.
[1mIT[0m should be reconciled and write all outputs to the output secret.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, without the list of outputs, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: not specifying the outputs list of .spec.writeOutputsToSecret.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains all outputs.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
--- PASS: Test_000041_all_outputs_test (1.05s)
=== RUN   Test_000042_output_name_contains_dot_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when its output names contain dots.
[1mIT[0m should be reconciled and allow to export outputs with dots in names.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, with controlled output, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: specifying the .spec.writeOutputsToSecret to output only `age.agekey` output.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains a binary data.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
--- PASS: Test_000042_output_name_contains_dot_test (1.06s)
=== RUN   Test_000043_controlled_outputs_should_be_reconciled_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when it is controlled the set of outputs.
[1mIT[0m the outputs should be reconciled if there were deleted
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, with controlled output, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: specifying the .spec.writeOutputsToSecret to output only `hello_world` output.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains a binary data.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
[1mIT[0m should reconcile the outputs back to the correct state if someone deleting them, even if no drift or no plan
[1mBY[0m: deleting the output secret
[1mBY[0m: checking that a new output secret is created
[1mBY[0m: checking that the secret is the new one
--- PASS: Test_000043_controlled_outputs_should_be_reconciled_test (1.56s)
=== RUN   Test_000044_plan_only_mode_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when PlanOnly is set
[1mIT[0m should be reconciled and write human readable plan output.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, without the list of outputs, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: not specifying the outputs list of .spec.writeOutputsToSecret.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains all outputs.
[1mBY[0m: checking that the output ConfigMap contains the correct output data, provisioned by the TF resource.
[1mIT[0m should be stopped.
[1mBY[0m: checking the ready condition is still Plan within 5 seconds.
--- PASS: Test_000044_plan_only_mode_test (1.05s)
=== RUN   Test_000050_plan_and_manual_approve_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource that is planned and manually approved.
[1mIT[0m should be reconciled to become planned.
[1mIT[0m should wait for a manually approval.
[1mIT[0m then should be reconciled to the applied state.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with manual approval, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource without specifying the .spec.approvePlan field.
[1mBY[0m: attaching the TF resource to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mBY[0m: checking that the TF's status conditions got reconciled.
[1mGIVEN[0m: the plan id is the `plan` plus the branch name (master) plus the commit id.
[1mBY[0m: checking that the planned status of the TF is created successfully.
[1mBY[0m: checking the reason is `TerraformPlannedWithChanges`.
[1mBY[0m: checking the pending plan is the $planId.
[1mBY[0m: checking the message of the ready status contains $planId.
[1mBY[0m: checking that the planned secret is created.
[1mBY[0m: checking that the label of the planned secret is the $planId.
[1mBY[0m: setting the .spec.approvePlan to be plan-main- and a part of commit id (b8e362c206) to approve the plan.
[1mIT[0m should continue the reconciliation process to the apply state.
[1mBY[0m: checking that the applied status reason is TerraformAppliedSucceed.
[1mBY[0m: checking that the last applied plan is really the pending plan.
[1mIT[0m should contain a list of available outputs in the status.
[1mBY[0m: checking that .status.availableOutput in the TF resource.
[1mIT[0m should not produce a Secret because the controller runs locally, outside Kubernetes.
[1mBY[0m: checking there are no secret generated by default.
--- PASS: Test_000050_plan_and_manual_approve_no_outputs_test (1.57s)
=== RUN   Test_000051_plan_and_manual_approve_and_replan_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource that is planned, and source changed to re-plan.
[1mIT[0m should be reconciled to become planned.
[1mIT[0m should wait for a manually approval.
[1mIT[0m then should be reconciled to the applied state.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with manual approval, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource without specifying the .spec.approvePlan field.
[1mBY[0m: attaching the TF resource to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mBY[0m: checking that the TF's status conditions got reconciled.
[1mGIVEN[0m: the plan id is the `plan` plus the branch name (master) plus the commit id.
[1mBY[0m: checking that the planned status of the TF is created successfully.
[1mBY[0m: checking the reason is `TerraformPlannedWithChanges`.
[1mBY[0m: checking the pending plan is the $planId.
[1mBY[0m: checking the message of the ready status contains $planId.
[1mBY[0m: checking that the planned secret is created.
[1mBY[0m: checking that the label of the planned secret is the $planId.
[1mBY[0m: changing source to a new revision
[1mBY[0m: checking the message of the ready status now contains the new $planId.
[1mBY[0m: setting the .spec.approvePlan to be plan-main- and a part of commit id (b8e362c206) to approve the plan.
[1mIT[0m should continue the reconciliation process to the apply state.
[1mBY[0m: checking that the applied status reason is TerraformAppliedSucceed.
[1mBY[0m: checking that the last applied plan is really the pending plan.
[1mIT[0m should contain a list of available outputs in the status.
[1mBY[0m: checking that .status.availableOutput in the TF resource.
[1mIT[0m should not produce a Secret because the controller runs locally, outside Kubernetes.
[1mBY[0m: checking there are no secret generated by default.
--- PASS: Test_000051_plan_and_manual_approve_and_replan_no_outputs_test (2.09s)
=== RUN   Test_000052_plan_and_manual_approve_with_files_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource that is planned and manually approved with a file generated inside the filesystem.
[1mIT[0m should be reconciled to become planned.
[1mIT[0m should wait for a manually approval.
[1mIT[0m then should be reconciled to the applied state.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with manual approval, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource without specifying the .spec.approvePlan field.
[1mBY[0m: attaching the TF resource to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mBY[0m: checking that the TF's status conditions got reconciled.
[1mGIVEN[0m: the plan id is the `plan` plus the branch name (master) plus the commit id.
[1mBY[0m: checking that the planned status of the TF is created successfully.
[1mBY[0m: checking the reason is `TerraformPlannedWithChanges`.
[1mBY[0m: checking the pending plan is the $planId.
[1mBY[0m: checking the message of the ready status contains $planId.
[1mBY[0m: checking that the planned secret is created.
[1mBY[0m: checking that the label of the planned secret is the $planId.
[1mBY[0m: setting the .spec.approvePlan to be plan-main- and a part of commit id (b8e362c206) to approve the plan.
[1mIT[0m should continue the reconciliation process to the apply state.
[1mBY[0m: checking that the applied status reason is TerraformAppliedSucceed.
[1mBY[0m: checking that the last applied plan is really the pending plan.
[1mIT[0m should contain a list of available outputs in the status.
[1mBY[0m: checking that .status.availableOutput in the TF resource.
--- PASS: Test_000052_plan_and_manual_approve_with_files_test (18.63s)
=== RUN   Test_000060_vars_and_controlled_outputs_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000060_vars_and_controlled_outputs_test (1.04s)
=== RUN   Test_000061_vars_hcl_input_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000061_vars_hcl_input_test (1.05s)
=== RUN   Test_000062_vars_hcl_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a secret to hold variables
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
Fulfilling prerequisites
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000062_vars_hcl_test (1.06s)
=== RUN   Test_000063_values_hcl_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
Fulfilling prerequisites
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000063_values_hcl_test (1.05s)
=== RUN   Test_000064_values_template_hcl_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
Fulfilling prerequisites Type: Reconciling Status: True
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000064_values_template_hcl_test (1.05s)
=== RUN   Test_000070_varsfrom_secret_and_controlled_outputs_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: preparing my-vars secret
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned By the TF hello world
--- PASS: Test_000070_varsfrom_secret_and_controlled_outputs_test (1.06s)
=== RUN   Test_000071_varsfrom_secret_with_varkeys_and_controlled_outputs_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: preparing my-vars secret
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned By the TF hello world
--- PASS: Test_000071_varsfrom_secret_with_varkeys_and_controlled_outputs_test (1.06s)
=== RUN   Test_000072_varsfrom_optional_secret_and_controlled_outputs_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo
[1mIT[0m should have an error
[1mBY[0m: checking that the Ready Status of the TF program reporting the artifact error.
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
[1mBY[0m: preparing my-vars secret
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000072_varsfrom_optional_secret_and_controlled_outputs_test (2.08s)
=== RUN   Test_000073_varsfrom_accepts_many_secrets
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: preparing vars configMaps
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the terraform resource got created
[1mBY[0m: checking that the TF output secret contains binary data
[1mBY[0m: checking that the TF output secret contains the correct output provisioned by the TF resource
--- PASS: Test_000073_varsfrom_accepts_many_secrets (1.08s)
=== RUN   Test_000074_varsfrom_accepts_many_secrets_with_last_supplied_key_precedence
[1mBY[0m: create the secrets
[1mBY[0m: creating a temporary working directory
[1mBY[0m: looking up the path of the terraform binary
[1mBY[0m: creating a new TF resource with slice of ConfigMaps
[1mBY[0m: creating a new TF exec instance
[1mBY[0m: verifying the generated vars file matches the expected result
--- PASS: Test_000074_varsfrom_accepts_many_secrets_with_last_supplied_key_precedence (0.08s)
=== RUN   Test_000071_varsfrom_secret_with_varkeys_rename_and_controlled_outputs_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: preparing my-vars secret, intentionally with test-data to later be renamed to subject
[1mBY[0m: creating a new TF and attaching to the repo, with test-data renamed to subject
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned By the TF hello world
--- PASS: Test_000071_varsfrom_secret_with_varkeys_rename_and_controlled_outputs_test (1.05s)
=== RUN   Test_000080_varsfrom_configmap_and_controlled_outputs_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: preparing my-vars configmap
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the plan was applied successfully
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000080_varsfrom_configmap_and_controlled_outputs_test (1.08s)
=== RUN   Test_000081_varsfrom_accepts_many_configMaps
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: preparing vars configMaps
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the terraform resource got created
[1mBY[0m: checking that the TF output secret contains binary data
[1mBY[0m: checking that the TF output secret contains the correct output provisioned by the TF resource
--- PASS: Test_000081_varsfrom_accepts_many_configMaps (1.06s)
=== RUN   Test_000082_varsfrom_accepts_many_configmaps_with_last_supplied_precedence
[1mBY[0m: create the configmaps
[1mBY[0m: creating a temporary working directory
[1mBY[0m: looking up the path of the terraform binary
[1mBY[0m: creating a new TF resource with slice of ConfigMaps
[1mBY[0m: creating a new TF exec instance
[1mBY[0m: verifying the generated vars file matches the expected result
--- PASS: Test_000082_varsfrom_accepts_many_configmaps_with_last_supplied_precedence (0.08s)
=== RUN   Test_000090_varsfrom_override_and_controlled_outputs_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: preparing my-vars secret
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned by the TF hello world
--- PASS: Test_000090_varsfrom_override_and_controlled_outputs_test (1.06s)
=== RUN   Test_000100_applied_resource_should_transit_back_to_plan_when_source_changed_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo, with no approve
[1mBY[0m: checking that the hello world TF get created
[1mBY[0m: checking that the TF condition got created
[1mBY[0m: checking that the planned status of the TF program is created successfully
[1mBY[0m: checking that the planned secret got created
[1mBY[0m: manually approving the plan.
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-1 is applied
[1mBY[0m: checking that we have outputs available in the TF object
[1mBY[0m: checking that we're testing the controller locally, then there should be no secret generated By default
[1mBY[0m: changing source to a new revision
[1mBY[0m: checking that the status of the TF object must be transitioned to planned
--- PASS: Test_000100_applied_resource_should_transit_back_to_plan_when_source_changed_test (2.09s)
=== RUN   Test_000110_auto_applied_resource_should_transit_to_plan_then_apply_when_source_changed_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo, with no approve
[1mBY[0m: checking that the hello world TF get created
[1mBY[0m: checking that the TF condition got created
[1mBY[0m: checking that the planned status of the TF program is created successfully
[1mBY[0m: checking that the planned secret got created
[1mBY[0m: manually approving the plan with auto.
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e362c206e is applied
[1mBY[0m: checking that we have outputs available in the TF object
[1mBY[0m: checking that we're testing the controller locally, then there should be no secret generated By default
[1mBY[0m: changing source to a new revision
[1mBY[0m: checking that the planned secret got updated
[1mBY[0m: checking that the status of the TF object then must be transitioned to applied
--- PASS: Test_000110_auto_applied_resource_should_transit_to_plan_then_apply_when_source_changed_test (2.09s)
=== RUN   Test_000111_with_backend_s3_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with backend configured, and `auto` approve.
[1mIT[0m should be reconciled from the plan state, to the apply state and have a correct TFSTATE stored inside the cluster as a Secret.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new Git repository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mIT[0m should be retrievable by the k8s client.
[1mBY[0m: getting it with the k8s client and succeed.
[1mBY[0m: preparing s3-backend-configs secret
time="2025-11-20T14:45:09Z" level=info msg="starting localstack"
time="2025-11-20T14:45:09Z" level=info msg="waiting for localstack to start..."
time="2025-11-20T14:45:13Z" level=info msg="localstack: finished waiting"
[1mBY[0m: creating the S3 bucket.
[1mBY[0m: creating the DynamoDB table.
[1mGIVEN[0m: a Terraform resource with auto approve, backend configured, attached to the given GitRepository.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should apply successfully.
[1mBY[0m: checking that the status of the TF resource is `TerraformAppliedSucceed`.
[1mIT[0m should be reconciled successfully, and have some output available.
[1mBY[0m: checking the output reason of the TF resource being `TerraformOutputsAvailable`.
[1mBY[0m: checking that the .status.availableOutputs contains an output named `hello_world`.
--- PASS: Test_000111_with_backend_s3_no_outputs_test (5.26s)
=== RUN   Test_000120_delete_test
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: checking that the hello world TF got created
[1mBY[0m: checking that the TF output secret contains a binary data
[1mBY[0m: checking that the TF output secrets contains the correct output provisioned By the TF hello world
--- PASS: Test_000120_delete_test (1.05s)
=== RUN   Test_000121_destroy_on_delete_test
[1mSPEC[0m: Terraform object with destroyResourcesOnDeletion should destroy all resources after object deletion.
[1mIT[0m should obtain the TF program's blob from the Source, unpack it, plan it, and apply it correctly with an output available, and there must be *NO* tfstate Secret because no backend specified.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mBY[0m: checking that we have outputs available in the TF object
[1mBY[0m: getting the tfstate and we should see it
[1mBY[0m: deleting TF object to trigger the destroy planning
[1mIT[0m should create the destroy plan, then apply
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mIT[0m should destroy the output and the created resources
--- PASS: Test_000121_destroy_on_delete_test (6.09s)
=== RUN   Test_000130_destroy_no_outputs_test
[1mSPEC[0m: Terraform object with no backend, auto approve, will be reconciled to have available outputs.
[1mIT[0m should obtain the TF program's blob from the Source, unpack it, plan it, and apply it correctly with an output available, and there must be *NO* tfstate Secret because no backend specified.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mBY[0m: checking that we have outputs available in the TF object
[1mBY[0m: getting the tfstate and we should see it
[1mIT[0m By updating TF object setting destroy=true to trigger the planning
[1mIT[0m should create the destroy plan, then apply
[1mIT[0m should destroy the output
[1mIT[0m should delete the TF object
[1mBY[0m: deleting the TF object
[1mIT[0m should not have the TF object anymore
[1mBY[0m: checking that the hello world TF got deleted
--- PASS: Test_000130_destroy_no_outputs_test (6.60s)
=== RUN   Test_000131_destroy_no_changes_test
[1mSPEC[0m: Terraform object with Kubernetes backend. Remove the object, no resource to destroy should not return an error.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve and destroyResourcesOnDeletion: true, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mBY[0m: checking that we have outputs available in the TF object
[1mIT[0m should stop auto-apply
[1mBY[0m: updating the hello world TF to stop auto-apply
[1mIT[0m should delete the cm payload
[1mBY[0m: deleting the cm payload
[1mIT[0m should delete the TF state
[1mBY[0m: deleting the tf state
[1mIT[0m should delete the TF object
[1mBY[0m: deleting the TF object
[1mIT[0m should not have the TF object anymore
[1mBY[0m: checking that the hello world TF got deleted
--- PASS: Test_000131_destroy_no_changes_test (8.11s)
=== RUN   Test_000140_auto_applied_resource_should_transit_to_plan_then_apply_when_drift_detected_test
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mBY[0m: checking that we have outputs available in the TF object
[1mBY[0m: getting the tfstate and we should see it
[1mBY[0m: deleting configmap to create a drift
[1mBY[0m: checking that the drift got detected, setting LastDriftDetectedAt time
[1mBY[0m: checking that the drift got detected, applying is progressing
[1mBY[0m: checking that the status of the TF object then must be transitioned to applied
--- PASS: Test_000140_auto_applied_resource_should_transit_to_plan_then_apply_when_drift_detected_test (12.22s)
=== RUN   Test_000150_manual_apply_should_report_and_loop_when_drift_detected_test
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mBY[0m: checking that we have outputs available in the TF object
[1mBY[0m: getting the tfstate and we should see it
[1mBY[0m: deleting configmap to create a drift
[1mBY[0m: checking that the drift got detected, setting LastDriftDetectedAt time
--- PASS: Test_000150_manual_apply_should_report_and_loop_when_drift_detected_test (18.30s)
=== RUN   Test_000160_auto_applied_should_tx_to_plan_when_unrelated_source_changed_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with auto approve, when an unrelated non-TF file triggers a source change.
[1mIT[0m should transition to planned, with no change.
[1mIT[0m should contain the *new* revision in .status.lastAttemptedRevision.
[1mIT[0m should contain the *old* revision in .status.lastAppliedRevision.
[1mIT[0m should contain the *new* revision in .status.lastPlannedRevision.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the hello world TF get created
[1mBY[0m: checking that the TF condition got created
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e362c206e is applied
[1mBY[0m: checking that the config map payload got created.
[1mGIVEN[0m: a new revision of resource, triggered by a non-TF file change.
[1mBY[0m: changing source to a new revision.
[1mBY[0m: checking that the planned secret should be updated, even with no change - because we did plan.
[1mBY[0m: checking that the status of the TF resource must be transitioned to planned, no change.
--- PASS: Test_000160_auto_applied_should_tx_to_plan_when_unrelated_source_changed_test (6.11s)
=== RUN   Test_000170_if_apply_error_the_plan_should_be_deleted_and_start_over_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with auto approve, when apply fail because the entity exists, it needs to start planning again.
[1mIT[0m should clear the pending.
[1mIT[0m should transition to planned.
[1mIT[0m should layer transition to applied again.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the hello world TF get created
[1mBY[0m: checking that the TF condition got created
[1mBY[0m: checking that the Ready status of the TF resource should fail, being TFExecApplyFailed.
[1mBY[0m: deleting the pre-existing config map.
[1mBY[0m: checking that the Ready status of the TF resource should become TerraformAppliedSucceed.
--- PASS: Test_000170_if_apply_error_the_plan_should_be_deleted_and_start_over_test (22.29s)
=== RUN   Test_000180_should_detect_drift_test
[1mSPEC[0m: This spec describes behaviour of the `shouldDetectDrift`.
[1mIT[0m should be false in the destroy mode.
[1mIT[0m should be false for the newly created object.
[1mIT[0m should be true for a normally applied object.
[1mIT[0m should be true for a non-TF source change.
[1mIT[0m should be true for a deleted / re-created object.
[1mIT[0m should be false for an object with the pending plan.
[1mIT[0m should be true for a normally applied object.
[1mIT[0m should be true for when ApprovePlan is disable
--- PASS: Test_000180_should_detect_drift_test (0.00s)
=== RUN   Test_000190_unsupported_source_should_error
[1mSPEC[0m: This spec describes the behaviour when an unsupported source reference is provided.
[1mBY[0m: submitting a new TF with an unsupported source
[1mIT[0m should return an error
--- PASS: Test_000190_unsupported_source_should_error (0.00s)
=== RUN   Test_000191_missing_source_should_error
[1mSPEC[0m: This spec describes the behaviour when a valid source reference cannot be found.
[1mBY[0m: submitting a Terraform resource referencing a git source which does not exist
[1mIT[0m should return a NotFound error
[1mBY[0m: submitting a Terraform resource referencing a bucket source which does not exist
[1mIT[0m should return a NotFound error
--- PASS: Test_000191_missing_source_should_error (0.00s)
=== RUN   Test_000200_disable_drift_detection
[1mSPEC[0m: This spec describes behaviour when drift detection is disabled
[1mIT[0m should not detect drift when true
[1mIT[0m should detect drift when false
--- PASS: Test_000200_disable_drift_detection (0.00s)
=== RUN   Test_000201_auto_approve_with_disabled_drift_detection
[1mSPEC[0m: This spec describes behaviour when drift detection is disabled
[1mIT[0m should not perform drift detection
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo, with approve plan set to auto and drift detection disabled
[1mBY[0m: checking that the hello world TF gets created
[1mBY[0m: checking that the plan was applied successfully
[1mBY[0m: checking that we have outputs available in the TF object
[1mBY[0m: ensuring that the Ready condition is not changed to `NoDrift`
--- PASS: Test_000201_auto_approve_with_disabled_drift_detection (31.57s)
=== RUN   Test_000210_plan_encode_decode_test
[1mSPEC[0m: This spec verifies gzip encoding and decoding func
[1mIT[0m should encode the terraform plan
[1mIT[0m should decode the encoded terraform plan
--- PASS: Test_000210_plan_encode_decode_test (0.00s)
=== RUN   Test_000230_drift_detection_only_mode
[1mSPEC[0m: This spec describes setting drift detection only mode which will skip the plan and apply stages
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with approvePlan set to disable, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should create and apply the plan successfully
[1mBY[0m: checking that the Ready condition is True with reason TerraformAppliedSucceed
[1mIT[0m should be in drift detection only mode
[1mBY[0m: setting approvePlan to disable
[1mBY[0m: checking that the Ready condition is true with reason NoDrift
[1mIT[0m should ensure that drift detection only mode is not impacted by spec.force=true
[1mBY[0m: setting force to true
[1mBY[0m: checking that the Ready condition remains true with reason NoDrift
[1mIT[0m should continue to detect and report drift
[1mBY[0m: deleting configmap to create a drift
[1mBY[0m: checking that the Ready condition transitioned to False with reason DriftDetected
--- PASS: Test_000230_drift_detection_only_mode (11.18s)
=== RUN   Test_000240_health_check_test
[1mSPEC[0m: This spec verifies health check functionalities
[1mIT[0m should do tcp health checks and not expecting any errors
[1mIT[0m should do tcp health checks and expecting errors
[1mIT[0m should do tcp health checks and expecting errors
[1mIT[0m should do tcp health checks and expecting errors
[1mIT[0m should do http health checks and not expecting any errors
[1mIT[0m should do http health checks and expecting errors
[1mIT[0m should do http health checks and expecting errors
[1mIT[0m should do http health checks and expecting errors
--- PASS: Test_000240_health_check_test (0.04s)
=== RUN   Test_000241_auto_approve_with_health_checks_test
[1mSPEC[0m: This spec describes behaviour when health checks are specified
[1mIT[0m should do health checks
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo, with approve plan set to auto and health checks defined
[1mBY[0m: checking that the health check example TF gets created
[1mBY[0m: checking that the plan was applied successfully
[1mBY[0m: checking that we have outputs available in the TF object
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains all outputs.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
[1mBY[0m: checking that the health checks are performed successfully
--- PASS: Test_000241_auto_approve_with_health_checks_test (1.57s)
=== RUN   Test_000242_bad_healt_checks_test
[1mSPEC[0m: This spec describes behaviour when health checks are specified
[1mIT[0m should do health checks
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo, with approve plan set to auto and health checks defined
[1mBY[0m: checking that the health check example TF gets created
[1mBY[0m: checking that the health checks should fail
[1mBY[0m: checking that the health check example TF 2 gets created
[1mBY[0m: checking that the health checks example 2 should fail
--- PASS: Test_000242_bad_healt_checks_test (2.08s)
=== RUN   Test_000243_remediation_retry_test
[1mSPEC[0m: This spec describes the retry behaviour of a Terraform resource that repeatedly fails.
[1mIT[0m should retry up to the limit given in .spec.remediation.retries, and start again only when the spec changes.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable *bad* BLOB's URL, with the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the bad GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the bad repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has 1 element.
[1mIT[0m should stop retry
[1mBY[0m: when reached retry limit specified in .Spec.Remediation.Retries
[1mIT[0m should restart retry count
[1mBY[0m: when resource was updated
[1mIT[0m should reset the retry count
[1mBY[0m: detecting a new artifact for the source GitRepository
--- PASS: Test_000243_remediation_retry_test (26.46s)
=== RUN   Test_000260_runner_pod_test
[1mSPEC[0m: This spec describes a runner pod creation process
[1mIT[0m generate a runner pod template
[1mBY[0m: passing a terraform object, the runner pod template should be accurate
--- PASS: Test_000260_runner_pod_test (0.00s)
=== RUN   Test_000260_runner_pod_test_env_vars
[1mSPEC[0m: This spec describes a runner pod creation process
[1mIT[0m generate a runner pod template
[1mBY[0m: passing a terraform object, the runner pod template should be accurate
--- PASS: Test_000260_runner_pod_test_env_vars (0.00s)
=== RUN   Test_000260_runner_pod_test_env_vars_proxy
[1mSPEC[0m: This spec describes a runner pod creation process
[1mIT[0m generate a runner pod template
[1mBY[0m: passing a terraform object, the runner pod template should be accurate
--- PASS: Test_000260_runner_pod_test_env_vars_proxy (0.00s)
=== RUN   Test_000260_runner_pod_test_env_vars_proxy_overwrite
[1mSPEC[0m: This spec describes a runner pod creation process
[1mIT[0m generate a runner pod template
[1mBY[0m: passing a terraform object, the runner pod template should be accurate
--- PASS: Test_000260_runner_pod_test_env_vars_proxy_overwrite (0.00s)
=== RUN   Test_000260_runner_pod_test_env_vars_proxy_output
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when variables are provided via EnvVars.
[1mIT[0m should be reconciled and output the variable in an output.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: specifying the .spec.writeOutputsToSecret.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should apply successfully.
[1mBY[0m: checking that the status of the TF resource is `TerraformAppliedSucceed`.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains 3 data fields.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
--- PASS: Test_000260_runner_pod_test_env_vars_proxy_output (3.10s)
=== RUN   Test_000260_runner_pod_test_env_vars_provider_vars_with_value
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when variables are provided via EnvVars.
[1mIT[0m should be reconciled and a vault provider successfully created.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: specifying the .spec.writeOutputsToSecret.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should fail to plan.
[1mBY[0m: checking that the status of the TF resource is `TFExecPlanFailedReason` due to `no such host` or `server misbehaving` failure.

Error: Get "https://vault:9123/v1/auth/token/lookup-self": dial tcp: lookup vault on 10.10.30.1:53: no such host

  with provider["registry.terraform.io/hashicorp/vault"],
  on main.tf line 12, in provider "vault":
  12: provider "vault" {

--- PASS: Test_000260_runner_pod_test_env_vars_provider_vars_with_value (7.14s)
=== RUN   Test_000260_runner_pod_test_env_vars_provider_vars_without_value
    tc000260_runner_pod_test.go:698: Flaky, couldn't make it stable
--- SKIP: Test_000260_runner_pod_test_env_vars_provider_vars_without_value (0.00s)
=== RUN   Test_000260_runner_pod_test_env_vars_valueFrom_secretRef
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when variables are provided via EnvVars.
[1mIT[0m should be reconciled and a vault provider successfully created.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Secret
[1mIT[0m should exist
[1mBY[0m: creating it with the client
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: specifying the .spec.writeOutputsToSecret.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should fail to plan.
[1mBY[0m: checking that the status of the TF resource is `TFExecPlanFailedReason` due to `no such host` failure.

Error: Get "https://vault:9123/v1/auth/token/lookup-self": dial tcp: lookup vault on 10.10.30.1:53: no such host

  with provider["registry.terraform.io/hashicorp/vault"],
  on main.tf line 12, in provider "vault":
  12: provider "vault" {

--- PASS: Test_000260_runner_pod_test_env_vars_valueFrom_secretRef (7.66s)
=== RUN   Test_000260_runner_pod_test_env_vars_valueFrom_configMapRef
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when variables are provided via EnvVars.
[1mIT[0m should be reconciled and a vault provider successfully created.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Secret
[1mIT[0m should exist
[1mBY[0m: creating it with the client
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: specifying the .spec.writeOutputsToSecret.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should fail to plan.
[1mBY[0m: checking that the status of the TF resource is `TFExecPlanFailedReason` due to `no such host` failure.

Error: Get "https://vault:9123/v1/auth/token/lookup-self": dial tcp: lookup vault on 10.10.30.1:53: no such host

  with provider["registry.terraform.io/hashicorp/vault"],
  on main.tf line 12, in provider "vault":
  12: provider "vault" {

--- PASS: Test_000260_runner_pod_test_env_vars_valueFrom_configMapRef (7.14s)
=== RUN   Test_000280_inventory_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with inventory enabled.
[1mIT[0m should be reconciled successfully with a set of inventory entries shown in the status.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mBY[0m: checking that we have an entry in the inventory representing the configmap.
--- PASS: Test_000280_inventory_test (3.60s)
=== RUN   Test_000290_force_unlock_lock_identifier_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with force unlock.
[1mIT[0m should be reconciled successfully with a set of inventory entries shown in the status.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mIT[0m should fail to reconcile
[1mBY[0m: checking that the StateLocked condition exists with Status True
--- PASS: Test_000290_force_unlock_lock_identifier_test (9.66s)
=== RUN   Test_000290_force_unlock_yes_unlock_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with inventory enabled.
[1mIT[0m should be reconciled successfully with a set of inventory entries shown in the status.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mIT[0m should fail to reconcile
[1mBY[0m: checking that the StateLocked condition exists with Status True
[1mIT[0m should reconcile
[1mBY[0m: checking that the StateLocked condition exists with Status False
--- PASS: Test_000290_force_unlock_yes_unlock_test (12.20s)
=== RUN   Test_000290_force_unlock_auto_unlock_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with inventory enabled.
[1mIT[0m should be reconciled successfully with a set of inventory entries shown in the status.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository object
[1mBY[0m: creating the GitRepository object
[1mGIVEN[0m: that the GitRepository got reconciled
[1mBY[0m: setting the GitRepository's status, with the BLOB's URL, and the correct checksum
[1mGIVEN[0m: a Terraform object with auto approve, and attaching it to the GitRepository object
[1mBY[0m: creating a new TF resource and attaching to the repo via sourceRef
[1mIT[0m should be created
[1mBY[0m: checking that the hello world TF got created
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the hello world TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mIT[0m should generate the Secret containing the plan named with branch and commit id
[1mBY[0m: checking that the Secret contains plan-master-b8e362c206 in its labels
[1mBY[0m: checking that the applied status of the TF program Successfully, and plan-master-b8e3 is applied
[1mIT[0m should reconcile
[1mBY[0m: checking that the StateLocked condition exists with Status False
--- PASS: Test_000290_force_unlock_auto_unlock_test (27.44s)
=== RUN   Test_000300_targets
[1mSPEC[0m: This spec describes the behavior of Terraform with targets.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF with targets set to one resource and attaching to the repo
[1mIT[0m should have conditions reconciled
[1mBY[0m: checking that the TF's status conditions has some elements
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mBY[0m: checking that the multi resources TF got created and contains one resource in the inventory
[1mIT[0m should create one config map
[1mBY[0m: removing the targets on the apply
[1mIT[0m should create all resources
[1mIT[0m should have its plan reconciled
[1mBY[0m: checking that the Plan's Status of the TF program is Planned Succeed.
[1mBY[0m: checking that all resources are listed in the inventory
[1mBY[0m: checking that config map resource one exists
[1mBY[0m: Checking that config map resource two exists
[1mGIVEN[0m: a Terraform object with targets set to resource two
[1mBY[0m: deleting TF object to trigger the destroy planning
[1mIT[0m should create the destroy plan, then apply
[1mIT[0m should destroy resource two
[1mIT[0m should NOT destroy resource one
--- PASS: Test_000300_targets (12.68s)
=== RUN   Test_000310_node_selector_test
[1mSPEC[0m: This spec describes the runner pod when it has a NodeSelector defined.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is a node selector defined
--- PASS: Test_000310_node_selector_test (0.02s)
=== RUN   Test_000310_affinity_test
[1mSPEC[0m: This spec describes the runner pod when it has Affinity defined.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is a node selector term defined
--- PASS: Test_000310_affinity_test (0.02s)
=== RUN   Test_000310_tolerations_test
[1mSPEC[0m: This spec describes the runner pod when it has Tolerations defined.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is a node selector term defined
--- PASS: Test_000310_tolerations_test (0.02s)
=== RUN   Test_000311_init_container_test
[1mSPEC[0m: This spec describes the runner pod when it has an Init Container defined.
[1mIT[0m should be defined on the Terraform object and appear correctly on the Pod object
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.runnerPodTemplate.spec.initContainers specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is an init container defined
--- PASS: Test_000311_init_container_test (0.02s)
=== RUN   Test_000311_init_container_delay_all_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource when not specified a list of output to .spec.writeOutputsToSecret.
[1mIT[0m should be reconciled and write all outputs to the output secret.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with auto approve, without the list of outputs, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mBY[0m: not specifying the outputs list of .spec.writeOutputsToSecret.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains all outputs.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
--- PASS: Test_000311_init_container_delay_all_outputs_test (1.04s)
=== RUN   Test_000320_default_volume_test
[1mSPEC[0m: This spec describes the runner pod when Volume are NOT defined.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is a default vols defined
--- PASS: Test_000320_default_volume_test (0.53s)
=== RUN   Test_000320_default_volume_mounts_test
[1mSPEC[0m: This spec describes the runner pod when Volume Mounts are NOT defined.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is a default vol mounts defined
--- PASS: Test_000320_default_volume_mounts_test (0.52s)
=== RUN   Test_000320_volume_test
[1mSPEC[0m: This spec describes the runner pod when Volume are defined.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is additional vols defined
--- PASS: Test_000320_volume_test (0.02s)
=== RUN   Test_000320_volume_mounts_test
[1mSPEC[0m: This spec describes the runner pod when additional Volume Mounts are defined.
[1mIT[0m should be reconciled, planned successfully, and stopped to wait for a manual approve.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled
[1mGIVEN[0m: a Terraform resource with manual approve, attached to the given GitRepository
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`, with no .spec.approvePlan specified.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should run the pod
[1mBY[0m: checking that there is vol mounts defined
--- PASS: Test_000320_volume_mounts_test (0.53s)
=== RUN   Test_000330_file_mapping_no_outputs_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with no backend, and `auto` approve.
[1mIT[0m should be reconciled to have available outputs.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: preparing test-file-mapping-w-output secret
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains a binary data.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
--- PASS: Test_000330_file_mapping_no_outputs_test (1.08s)
=== RUN   Test_000340_PrepareWebhookPayloadSpecAndPlan
--- PASS: Test_000340_PrepareWebhookPayloadSpecAndPlan (0.00s)
=== RUN   Test_000340_PrepareWebhookPayloadSpecOnly
--- PASS: Test_000340_PrepareWebhookPayloadSpecOnly (0.00s)
=== RUN   Test_000340_PrepareWebhookPayloadPlanOnly
--- PASS: Test_000340_PrepareWebhookPayloadPlanOnly (0.00s)
=== RUN   Test_000340_webhooks_for_post_planning_test
[1mSPEC[0m: This spec describes the behaviour of webhooks for the post-planning stage of Terraform CR.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should stop by the webhook because it returns passed=false.
--- PASS: Test_000340_webhooks_for_post_planning_test (1.05s)
=== RUN   Test_000350_depends_on_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource that is planned and manually approved.
[1mIT[0m should be reconciled to become planned.
[1mIT[0m should wait for a manually approval.
[1mIT[0m then should be reconciled to the applied state.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mBY[0m: checking that the status and its URL gets reconciled.
[1mGIVEN[0m: a Terraform resource with manual approval, attached to the given GitRepository resource
[1mBY[0m: creating a new TF resource without specifying the .spec.approvePlan field.
[1mBY[0m: attaching the TF resource to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mBY[0m: checking that the TF's status conditions got reconciled.
[1mGIVEN[0m: the plan id is the `plan` plus the branch name (master) plus the commit id.
[1mBY[0m: checking that the planned status of the TF is created successfully.
[1mBY[0m: checking the reason is `TerraformPlannedWithChanges`.
[1mBY[0m: checking the pending plan is the $planId.
[1mBY[0m: checking the message of the ready status contains $planId.
[1mBY[0m: checking that the planned secret is created.
[1mBY[0m: checking that the label of the planned secret is the $planId.
[1mBY[0m: creating a new Git repository object
[1mBY[0m: setting the git repo status object, the URL, and the correct checksum
[1mBY[0m: checking that the status and its URL gets reconciled
[1mBY[0m: creating a new TF and attaching to the repo
[1mBY[0m: setting the .spec.approvePlan to be plan-main- and a part of commit id (b8e362c206) to approve the plan.
[1mIT[0m should continue the reconciliation process to the apply state.
[1mBY[0m: checking that the applied status reason is TerraformAppliedSucceed.
[1mBY[0m: checking that the last applied plan is really the pending plan.
[1mIT[0m should contain a list of available outputs in the status.
[1mBY[0m: checking that .status.availableOutput in the TF resource.
[1mIT[0m should contain the output value in the secret.
[1mBY[0m: checking that the output secret is created.
--- PASS: Test_000350_depends_on_test (12.25s)
=== RUN   Test_000360_tfvars_files_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with no backend, and `auto` approve.
[1mIT[0m should be reconciled to have available outputs.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should be planned.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TerraformPlannedWithChanges`.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and produce the correct output secret.
[1mBY[0m: checking that the named output secret contains a binary data.
[1mBY[0m: checking that the output secret contains the correct output data, provisioned by the TF resource.
--- PASS: Test_000360_tfvars_files_test (0.53s)
=== RUN   Test_000360_tfvars_files_bad_path_test
[1mSPEC[0m: This spec describes the behaviour of a Terraform resource with no backend, and `auto` approve.
[1mIT[0m should be reconciled to have available outputs.
[1mGIVEN[0m: a GitRepository
[1mBY[0m: defining a new GitRepository resource.
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource with auto approve, attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource existed inside the cluster.
[1mIT[0m should be reconciled and contain some status conditions.
[1mBY[0m: checking that the TF resource's status conditions has some elements.
[1mIT[0m should fail to plan.
[1mBY[0m: checking that the Plan's reason of the TF resource become `TFExecPlanFailed`.
--- PASS: Test_000360_tfvars_files_bad_path_test (0.53s)
=== RUN   Test_009990_mtls_generate_creds_test
[1mSPEC[0m: This spec describes the behaviour when generating tls certs for mTLS
[1mIT[0m should create the ca and runner certs
[1mBY[0m: creating the GitRepository resource in the cluster.
[1mIT[0m should be created successfully.
[1mGIVEN[0m: the GitRepository's reconciled status.
[1mBY[0m: setting the GitRepository's status, with the downloadable BLOB's URL, and the correct checksum.
[1mIT[0m should be updated successfully.
[1mGIVEN[0m: a Terraform resource  attached to the given GitRepository resource.
[1mBY[0m: creating a new TF resource and attaching to the repo via `sourceRef`.
[1mIT[0m should be created and attached successfully.
[1mBY[0m: checking that the TF resource exists.
[1mBY[0m: checking that the runner secret gets created
[1mBY[0m: verifying that the certificate authority cert is valid
[1mBY[0m: verifying that the runner cert secret has the appropriate labels
[1mBY[0m: verifying that the runner cert is valid for a range of hostnames in a given namespace
[1mBY[0m: verifying that the runner cert is valid only for the terraform runner namespace
[1mBY[0m: rotating the CA should renew the server cert
[1mBY[0m: checking that the runner secret gets updated
[1mBY[0m: ensuring that the refreshed runner cert is valid
--- PASS: Test_009990_mtls_generate_creds_test (0.57s)
=== RUN   TestValidateTCPAddress
--- PASS: TestValidateTCPAddress (0.00s)
PASS
coverage: 66.3% of statements
ok  	github.com/flux-iac/tofu-controller/controllers	344.634s	coverage: 66.3% of statements
